name: Release Telegram Notification

on:
  release:
    types: [published]
  push:
    tags:
      - '*'

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
    steps:
      - name: Prepare release notification message
        run: |
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
          if [[ -z "$TELEGRAM_BOT_TOKEN" || -z "$TELEGRAM_CHAT_ID" ]]; then
            echo "MESSAGE=" >> $GITHUB_ENV
            exit 0
          fi

          # Ð­ÐºÑ€Ð°Ð½Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ‹ Ð´Ð»Ñ MarkdownV2
          escape_markdown() {
            echo "$1" | sed -e 's/[_*[\]()~`>#+\-=|{}.!]/\\&/g'
          }

          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
          EVENT_NAME="${{ github.event_name }}"

          if [[ "$EVENT_NAME" == "release" ]]; then
            # Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ GitHub Release
            RELEASE_TAG="${{ github.event.release.tag_name }}"
            RELEASE_NAME="${{ github.event.release.name }}"
            RELEASE_BODY="${{ github.event.release.body }}"
            RELEASE_URL="${{ github.event.release.html_url }}"
            RELEASE_AUTHOR="${{ github.event.release.author.login }}"

            ESCAPED_TAG=$(escape_markdown "$RELEASE_TAG")
            ESCAPED_NAME=$(escape_markdown "$RELEASE_NAME")
            ESCAPED_AUTHOR=$(escape_markdown "$RELEASE_AUTHOR")

            # ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð»Ð¸Ð½Ñƒ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ Ñ€ÐµÐ»Ð¸Ð·Ð° (Telegram Ð¸Ð¼ÐµÐµÑ‚ Ð»Ð¸Ð¼Ð¸Ñ‚ Ð½Ð° Ð´Ð»Ð¸Ð½Ñƒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ)
            if [[ ${#RELEASE_BODY} -gt 500 ]]; then
              RELEASE_BODY="${RELEASE_BODY:0:500}..."
            fi
            ESCAPED_BODY=$(escape_markdown "$RELEASE_BODY")

            # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ñ€ÐµÐ»Ð¸Ð·Ð°
            MESSAGE="ðŸš€ *ÐÐ¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ»Ð¸Ð·:* \`${ESCAPED_TAG}\`"

            # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ»Ð¸Ð·Ð°, ÐµÑÐ»Ð¸ Ð¾Ð½Ð¾ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð°ÐµÑ‚ÑÑ Ð¾Ñ‚ Ñ‚ÐµÐ³Ð°
            if [[ -n "$RELEASE_NAME" && "$RELEASE_NAME" != "$RELEASE_TAG" ]]; then
              MESSAGE="${MESSAGE}\n*${ESCAPED_NAME}*"
            fi

            # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ, ÐµÑÐ»Ð¸ Ð¾Ð½Ð¾ ÐµÑÑ‚ÑŒ
            if [[ -n "$RELEASE_BODY" ]]; then
              MESSAGE="${MESSAGE}\n\nðŸ“ *ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ:*\n${ESCAPED_BODY}"
            fi

            # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ñ€Ð°
            MESSAGE="${MESSAGE}\n\nðŸ‘¤ *ÐÐ²Ñ‚Ð¾Ñ€:* ${ESCAPED_AUTHOR}"

            # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÑÑ‹Ð»ÐºÑƒ
            MESSAGE="${MESSAGE}\nðŸ”— [ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ñ€ÐµÐ»Ð¸Ð·](${RELEASE_URL})"

          else
            # Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ push Ñ Ñ‚ÐµÐ³Ð¾Ð¼
            TAG_REF="${{ github.ref }}"
            TAG_NAME="${TAG_REF#refs/tags/}"
            COMMIT_SHA="${{ github.sha }}"
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            TAG_AUTHOR="${{ github.event.head_commit.author.username }}"
            REPO_URL="https://github.com/${{ github.repository }}"
            TAG_URL="${REPO_URL}/releases/tag/${TAG_NAME}"

            ESCAPED_TAG=$(escape_markdown "$TAG_NAME")
            ESCAPED_AUTHOR=$(escape_markdown "$TAG_AUTHOR")

            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿ÐµÑ€Ð²ÑƒÑŽ ÑÑ‚Ñ€Ð¾ÐºÑƒ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°
            COMMIT_FIRST_LINE=$(echo "$COMMIT_MSG" | head -n 1)
            if [[ ${#COMMIT_FIRST_LINE} -gt 200 ]]; then
              COMMIT_FIRST_LINE="${COMMIT_FIRST_LINE:0:200}..."
            fi
            ESCAPED_COMMIT=$(escape_markdown "$COMMIT_FIRST_LINE")

            # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ñ‚ÐµÐ³Ð°
            MESSAGE="ðŸ· *ÐÐ¾Ð²Ñ‹Ð¹ Ñ‚ÐµÐ³:* \`${ESCAPED_TAG}\`"
            MESSAGE="${MESSAGE}\n\nðŸ“ *ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚:* ${ESCAPED_COMMIT}"
            MESSAGE="${MESSAGE}\n\nðŸ‘¤ *ÐÐ²Ñ‚Ð¾Ñ€:* ${ESCAPED_AUTHOR}"
            MESSAGE="${MESSAGE}\nðŸ”— [ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ñ‚ÐµÐ³](${TAG_URL})"
          fi

          echo "MESSAGE=$MESSAGE" >> $GITHUB_ENV

      - name: Send Telegram message
        if: env.MESSAGE != ''
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ env.TELEGRAM_CHAT_ID }} \
            -d text="${{ env.MESSAGE }}" \
            -d parse_mode="MarkdownV2"
