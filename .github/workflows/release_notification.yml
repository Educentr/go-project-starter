name: Release Telegram Notification

on:
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
    steps:
      - name: Prepare release notification message
        id: prepare
        run: |
          # Check secrets
          if [[ -z "$TELEGRAM_BOT_TOKEN" || -z "$TELEGRAM_CHAT_ID" ]]; then
            echo "Telegram credentials not configured, skipping notification"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Escape special characters for MarkdownV2
          escape_markdown() {
            echo "$1" | sed -e 's/[_*[\]()~`>#+\-=|{}.!]/\\&/g'
          }

          # Escape for bold text (don't escape asterisks since we need them for bold)
          escape_for_bold() {
            echo "$1" | sed -e 's/[_[\]()~`>#+\-=|{}.!]/\\&/g'
          }

          # Get release data using heredoc to safely handle multiline content
          RELEASE_TAG=$(cat <<'EOF'
          ${{ github.event.release.tag_name }}
          EOF
          )

          RELEASE_NAME=$(cat <<'EOF'
          ${{ github.event.release.name }}
          EOF
          )

          RELEASE_BODY=$(cat <<'EOF'
          ${{ github.event.release.body }}
          EOF
          )

          RELEASE_URL=$(cat <<'EOF'
          ${{ github.event.release.html_url }}
          EOF
          )

          RELEASE_AUTHOR=$(cat <<'EOF'
          ${{ github.event.release.author.login }}
          EOF
          )

          # Trim whitespace
          RELEASE_TAG=$(echo "$RELEASE_TAG" | xargs)
          RELEASE_NAME=$(echo "$RELEASE_NAME" | xargs)
          RELEASE_URL=$(echo "$RELEASE_URL" | xargs)
          RELEASE_AUTHOR=$(echo "$RELEASE_AUTHOR" | xargs)

          ESCAPED_TAG=$(escape_for_bold "$RELEASE_TAG")
          ESCAPED_NAME=$(escape_markdown "$RELEASE_NAME")
          ESCAPED_AUTHOR=$(escape_markdown "$RELEASE_AUTHOR")

          # Limit release body length (Telegram has message length limits)
          if [[ ${#RELEASE_BODY} -gt 500 ]]; then
            RELEASE_BODY="${RELEASE_BODY:0:500}..."
          fi
          ESCAPED_BODY=$(escape_markdown "$RELEASE_BODY")

          # Build message for release
          MESSAGE="ðŸš€ *New release:* *${ESCAPED_TAG}*"

          # Add release name if different from tag
          if [[ -n "$RELEASE_NAME" && "$RELEASE_NAME" != "$RELEASE_TAG" ]]; then
            MESSAGE="${MESSAGE}\n*${ESCAPED_NAME}*"
          fi

          # Add description if present
          if [[ -n "$RELEASE_BODY" ]]; then
            MESSAGE="${MESSAGE}\n\nðŸ“ *Description:*\n${ESCAPED_BODY}"
          fi

          # Add author
          MESSAGE="${MESSAGE}\n\nðŸ‘¤ *Author:* ${ESCAPED_AUTHOR}"

          # Add link
          MESSAGE="${MESSAGE}\nðŸ”— [View release](${RELEASE_URL})"

          # Save message to file to avoid shell escaping issues
          echo -e "$MESSAGE" > /tmp/telegram_message.txt
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Send Telegram message
        if: steps.prepare.outputs.skip != 'true'
        run: |
          MESSAGE=$(cat /tmp/telegram_message.txt)

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "parse_mode=MarkdownV2" \
            --data-urlencode "text=${MESSAGE}"
