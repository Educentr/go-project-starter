# LLMS.md

This file provides guidance to AI coding agents (Claude Code, Codex, Cursor, etc.) when working with this codebase.

## Project Overview

**{{ .ProjectName }}** is a Go microservice generated by [go-project-starter](https://github.com/Educentr/go-project-starter).

- **Go module**: `{{ .ProjectPath }}`
- **Logger**: {{ .Logger.FilesToGenerate }}
{{- if .UseActiveRecord }}
- **Database**: PostgreSQL with ActiveRecord ORM
{{- end }}
{{- if .DevStand }}
- **Dev environment**: docker-compose-dev with OnlineConf
{{- end }}

## Critical Rules

### NEVER modify generated files

- **NEVER** edit files with `_gen` suffix (`*_gen.go`, `psg_*_gen.go`). They are auto-generated and overwritten on regeneration.
- To customize generated behavior:
  - Write wrapper functions in non-generated files
  - Override behavior in manual code that calls generated code
  - For structural changes, modify `.project-config/project.yaml` and run `make regenerate`

### Disclaimer markers

Generated files contain disclaimer markers that separate generated code from manual code:

```go
// Code generated by projectStarter generator. DO NOT EDIT file before this message.
// If you need you can add your code after this message
```

- Code **above** the marker: regenerated on each run — do NOT edit
- Code **below** the marker: preserved forever — write your code here

### Three-layer architecture

| Layer | Path | Rules |
|-------|------|-------|
| **Runtime** | `pkg/` | Reusable libraries. No config dependency. Can be extracted as a separate Go module. |
| **Core** | `internal/pkg/` | Business logic, models, repositories. Config-agnostic. No logger binding — return errors upward. |
| **App** | `internal/app/` | Project-specific code. Config-aware. Contains transport handlers, workers, service layer. |

**Dependency direction**: `internal/app/` → `internal/pkg/` → `pkg/` (never the reverse).

## Where to Put Code

| What | Where |
|------|-------|
| REST handler logic | `internal/app/transport/rest/{transport_name}/{version}/handler/` — below disclaimer marker |
| gRPC handler logic | `internal/app/transport/rest/{service_name}/handler/` — below disclaimer marker |
| Business logic | `internal/pkg/service/` — extend the Service struct in non-generated files |
| Data models | `internal/pkg/model/` |
| Constants | `internal/app/constant/` — add below disclaimer in existing file or create new files |
| Worker job logic | `internal/app/worker/{type}/{name}/` — implement in `job.go` / `worker.go` |
| Middleware | `internal/app/transport/rest/{name}/{version}/` — implement in non-generated files |
{{- if .UseActiveRecord }}
| DB repository declarations | `internal/pkg/model/repository/decl/` — generated code goes to `cmpl/` |
{{- end }}

## Build Commands

```bash
make build                    # Build all binaries
make test                     # Run unit tests with coverage
make race                     # Run tests with race detector
make lint                     # Lint diffs against main branch
make lint-full                # Lint entire codebase
make lint-fix                 # Auto-fix linting issues
make generate                 # Run all code generators (ogen, protobuf, mocks{{ if .UseActiveRecord }}, argen{{ end }})
make regenerate               # Full project regeneration via go-project-starter
```

## Code Generation

### When to run which command

| Change | Command |
|--------|---------|
| OpenAPI spec (`api/rest/`) | `make generate-ogen` |
{{- if .UseActiveRecord }}
| ActiveRecord declarations (`decl/`) | `make generate-argen` |
{{- end }}
| Protobuf files (`api/proto/`) | `make generate` |
| `.project-config/project.yaml` | `make regenerate` |
| All generators | `make generate` |

### Regeneration safety

- Files with disclaimer markers: code above marker is regenerated, code below is preserved
- Files in `ignoreIfExistsFiles` (`.gitignore`, `go.mod`, `README.md`, `LLMS.md`, `LICENSE.txt`): never overwritten
- Files without disclaimer markers and no template: auto-deleted if obsolete
- User files (no markers): never touched
{{- if .UseActiveRecord }}

## ActiveRecord (Database)

- Repository declarations live in `internal/pkg/model/repository/decl/`
- Generated repository code goes to `internal/pkg/model/repository/cmpl/` — **never edit `cmpl/`**
- After ANY change to `decl/` files, run `make generate-argen`
- Use ActiveRecord methods for DB queries. Avoid complex raw SQL — use AR selectors and compute results in Go code.
{{- end }}
{{- if gt (len .Applications.GetRestTransport) 0 }}

## REST API

- REST servers are generated from OpenAPI 3.0 specs via [ogen](https://github.com/ogen-go/ogen)
- Specs are located in `api/rest/{transport_name}/{version}/`
- Generated code goes to `pkg/rest/{transport_name}/{version}/` — **never edit**
- Handler implementations go to `internal/app/transport/rest/{transport_name}/{version}/handler/`
- All contract (OpenAPI) changes must be made in the spec files, then run `make generate-ogen`

### Handler pattern

```go
type Handler struct {
    *rest.DefaultServiceHandler // Provides Srv (IService) access
}

func (h *Handler) MyEndpoint(ctx context.Context, req *oas.MyRequest) (*oas.MyResponse, error) {
    srv, err := h.GetEmptySrv(h.Srv)
    if err != nil {
        return nil, err
    }
    // Use srv for business logic
}
```
{{- end }}
{{- if gt (len .Applications.GetGrpcTransport) 0 }}

## gRPC

- Proto files are located in `api/proto/`
- Generated code goes to `pkg/grpc/` — **never edit**
- After proto changes, run `make generate`
{{- end }}
{{- if gt (len .Workers) 0 }}

## Workers

Workers are background processes that run periodically or react to events.

### Critical: Workers MUST be disabled by default

ALL new workers MUST have an `enabled` flag in OnlineConf set to `false`. Check it in `GetTasks()`:

```go
func (w *Worker) GetTasks(ctx context.Context, lastJobState any) ([]daemon.ITask, any, error) {
    enabled, _ := onlineconf.GetBool(ctx, w.GetConfigPath("enabled"), false)
    if !enabled {
        return nil, nil, nil
    }
    // ... task logic
}
```

### Worker types
{{ range $name, $worker := .Workers }}
- **{{ $name }}** ({{ $worker.GeneratorType }})
{{- end }}

### Worker configuration via OnlineConf

- Enabled flag: `/{{ .ProjectName }}/worker/{worker_name}/enabled`
- Batch size: `/{{ .ProjectName }}/worker/{worker_name}/batch_size`
- Jobs list: `/{{ .ProjectName }}/worker/{worker_name}/jobs/enabled`

### Worker jobs should be short

Process data in small batches (batch size configured via OnlineConf). Never create long-running tasks that process all records at once.
{{- end }}
{{- if gt (len .Kafka) 0 }}

## Kafka

### Producers and consumers
{{ range $name, $kafka := .Kafka }}
- **{{ $name }}** ({{ $kafka.Type }}, driver: {{ $kafka.Driver }})
{{- end }}

### Kafka configuration via OnlineConf

- Brokers: `/{{ .ProjectName }}/kafka/{client}/brokers`
- Topic overrides: `/{{ .ProjectName }}/kafka/{client}/events/{event_name}/topic`
- Auth: `/{{ .ProjectName }}/kafka/{client}/auth_type`, `username`, `password`
{{- end }}

## Service Layer

The Service struct (`internal/pkg/service/`) is the single source of business logic:

- Multiple transports (REST, gRPC, CLI, workers) call the same Service
- Generated base is in `psg_service_gen.go` — **never edit**
- Extend the Service in separate files (e.g., `payment.go`, `notification.go`)
- Service is isolated from transport specifics
- Drivers, REST/gRPC clients, and Kafka producers are injected into Service and accessible as fields

## OnlineConf (Dynamic Configuration)

OnlineConf provides runtime configuration without redeploy.

### Path hierarchy (3-level priority, highest to lowest)

1. **App-specific**: `/{{ .ProjectName }}/transport/rest/{transport_name}/{app_name}/{key}`
2. **Transport-level**: `/{{ .ProjectName }}/transport/rest/{transport_name}/{key}`
3. **Code default**: hardcoded in code

### Common paths

```
/{{ .ProjectName }}/devstand                                    # 0 or 1
/{{ .ProjectName }}/log/level                                   # info, debug, error
/{{ .ProjectName }}/transport/rest/{name}/ip                    # bind address
/{{ .ProjectName }}/transport/rest/{name}/port                  # listen port
/{{ .ProjectName }}/transport/rest/{name}/timeout_read          # read timeout
/{{ .ProjectName }}/transport/rest/{name}/timeout_write         # write timeout
/{{ .ProjectName }}/transport/rest/{name}/handler/{path}/timeout # per-endpoint timeout
{{- if .UseActiveRecord }}
/{{ .ProjectName }}/db/main/host                                # DB host
/{{ .ProjectName }}/db/main/user                                # DB user
/{{ .ProjectName }}/db/main/password                            # DB password
{{- end }}
```

### Environment variable override

Format: `OC_{{ "{{" }}ProjectName{{ "}}" }}__{path}__with__underscores=value`

### Rules

- **NEVER** modify files in `etc/onlineconf/` — use OnlineConf web interface for production/staging
- **NEVER** manually edit `*.cdb` files — they are binary databases generated by onlineconf-updater
- For test configuration only: edit `tests/etc/onlineconf/TREE.conf`
{{- if .DevStand }}

## Dev Environment

Start with `make dev-up`, stop with `make dev-down`.

Docker-compose-dev includes:
- OnlineConf Admin UI: http://localhost:8888 (admin/admin)
- Traefik dashboard: http://localhost:9080
{{- if .UseActiveRecord }}
- PostgreSQL database
{{- end }}

**Important**: When changing SQL init templates, delete MySQL volume first — init scripts only run on first start:

```bash
make dev-drop && make dev-up
```
{{- end }}
{{- if .Applications.HasGoatTests }}

## Integration Tests (GOAT)

```bash
make goat-tests               # Run all integration tests
make goat-tests-verbose       # With detailed output
```

### Rules

- **NEVER** call service functions directly from goat tests — test context does not have OnlineConf properly initialized
- Always test through API endpoints (REST handlers)
- Run `make build-for-test` after code changes before running `make test`
- Test suites inherit from `BaseTestSuite` and use `s.client` for HTTP requests
- Implement `ApplyMigrations` and `CleanupTables` for database setup/teardown
{{- end }}

## Applications

This service contains the following applications:
{{ range .Applications }}
### {{ .Name }}
{{- if .Transports }}
- **Transports**:
{{- range $name, $t := .Transports }}
  - `{{ $name }}` ({{ $t.Type }})
{{- end }}
{{- end }}
{{- if .Workers }}
- **Workers**:
{{- range $name, $w := .Workers }}
  - `{{ $name }}` ({{ $w.GeneratorType }})
{{- end }}
{{- end }}
{{- if .Kafka }}
- **Kafka**:
{{- range $name, $k := .Kafka }}
  - `{{ $name }}` ({{ $k.Type }})
{{- end }}
{{- end }}
{{- if .Drivers }}
- **Drivers**:
{{- range $name, $d := .Drivers }}
  - `{{ $name }}`
{{- end }}
{{- end }}
{{ end }}
## Project Structure

```
{{ .ProjectName }}/
├── cmd/                          # Entry points for each application
{{- range .Applications }}
│   └── {{ .Name }}/             # {{ .Name }} application
{{- end }}
├── internal/
│   ├── app/                     # Project-specific code (YOUR CODE)
│   │   ├── constant/            # Service constants
│   │   ├── transport/           # Transport handlers
│   │   │   └── rest/            # REST API handlers
{{- if gt (len .Workers) 0 }}
│   │   └── worker/              # Worker implementations
{{- end }}
│   └── pkg/                     # Core business logic
│       ├── model/               # Data models
{{- if .UseActiveRecord }}
│       │   └── repository/      # ActiveRecord repositories
│       │       ├── decl/        # Declarations (edit these)
│       │       └── cmpl/        # Generated (never edit)
{{- end }}
│       ├── service/             # Service layer (business logic)
│       └── ds/                  # Data structures
├── pkg/                         # Runtime libraries (reusable)
│   ├── app/                     # Application lifecycle
│   ├── drivers/                 # External service drivers
│   └── rest/                    # Generated REST client/server code
├── api/                         # API specifications
│   └── rest/                    # OpenAPI 3.0 specs
├── .project-config/             # Generator configuration
│   └── project.yaml             # Main config (source of truth)
├── configs/                     # Linter and tool configs
├── Makefile                     # Build automation (40+ targets)
└── tests/                       # Integration tests
```
