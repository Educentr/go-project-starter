name: CI Pipeline

on:
  push:
    branches:
      - main
      - staging

jobs:
  prepare-env:
    runs-on: ubuntu-latest
    outputs:
      ENABLE_BUILD: ${{"{{"}} steps.vars_enabled.outputs.ENABLE_BUILD {{"}}"}}
      RELEASE: ${{"{{"}} steps.vers_and_containers.outputs.RELEASE {{"}}"}}
{{- if .Artifacts.HasDocker }}
      CONTAINERS: ${{"{{"}} steps.vers_and_containers.outputs.CONTAINERS {{"}}"}}
{{- end }}
{{- if .Artifacts.HasDocker }}
      ARTIFACTS: ${{"{{"}} steps.vers_and_containers.outputs.ARTIFACTS {{"}}"}}
{{- end }}
{{- if .Artifacts.HasPackaging }}
      PACKAGES: ${{"{{"}} steps.vers_and_containers.outputs.PACKAGES {{"}}"}}
{{- end }}
{{- if .Artifacts.HasDocker }}
      ENABLE_DEPLOY: ${{"{{"}}steps.vars_enabled.outputs.ENABLE_DEPLOY {{"}}"}}
      DEPLOY_ENVS: ${{"{{"}} steps.vars_deploy.outputs.DEPLOY_ENVS {{"}}"}}
      OC_HOST: ${{"{{"}} steps.vars_deploy.outputs.OC_HOST {{"}}"}}
      OC_PORT: ${{"{{"}} steps.vars_deploy.outputs.OC_PORT {{"}}"}}
      OC_USER: ${{"{{"}} steps.set_env_main.outputs.OC_USER {{"}}"}}
      OC_PASSWORD: ${{"{{"}} steps.set_env_main.outputs.OC_PASSWORD {{"}}"}}
      ENV_TYPE: ${{"{{"}} steps.set_env_main.outputs.ENV_TYPE {{"}}"}}
      LEN_EXPECTED: ${{"{{"}} steps.vars_deploy.outputs.LEN_EXPECTED {{"}}"}}
      SSH_HOST_MATRIX: ${{"{{"}} steps.vars_deploy.outputs.SSH_HOST_MATRIX {{"}}"}}
      INTERNAL_SUBNET: ${{"{{"}} steps.vars_deploy.outputs.INTERNAL_SUBNET {{"}}"}}
      {{- range $_, $a := .Applications }}{{ if $a.HasDocker }}
        {{ $applicationName := $a.Name | ReplaceDash }}
      PORT_PREFIX_{{ $applicationName | ToUpper }}_TRAEFIK: ${{"{{"}} steps.set_env_main.outputs.PORT_PREFIX_{{ $applicationName | ToUpper }}_TRAEFIK {{"}}"}}
        {{- range $_, $t := $a.GetRestTransport }}{{ if ne $t.GeneratorType "ogen_client" }}
        {{ if $t.PublicService }}
      DOMAIN_{{ $t.Name | ToUpper }}: ${{"{{"}} steps.set_env_main.outputs.DOMAIN_{{ $t.Name | ToUpper }} {{"}}"}}
        {{ end }}
      PORT_PREFIX_{{ $applicationName | ToUpper }}_{{ $t.Name | ToUpper }}: ${{"{{"}} steps.set_env_main.outputs.PORT_PREFIX_{{ $applicationName | ToUpper }}_{{ $t.Name | ToUpper }} {{"}}"}}
        {{ end }}{{ end }}
      {{ end }}{{ end }}
{{- end }}

    steps:
      - name: Get branch
        uses: noliran/branch-based-secrets@v1
        with:
          secrets: ENABLED{{ if .Artifacts.HasDocker }},ENV_TYPE,OC_USER,OC_PASSWORD,OC_HOST,OC_PORT,{{- range $_, $a := .Applications }}{{ if $a.HasDocker }}PORT_PREFIX_{{ $a.Name | ToUpper | ReplaceDash }}_TRAEFIK,{{ range $_, $t := $a.GetRestTransport }}{{ if ne $t.GeneratorType "ogen_client" }}PORT_PREFIX_{{ $a.Name | ToUpper | ReplaceDash }}_{{ $t.Name | ToUpper }},{{ if $t.PublicService }}DOMAIN_{{ $t.Name | ToUpper }},{{ end }}{{ end }}{{ end }}{{ end }}{{ end }}SSH_HOST,INTERNAL_SUBNET{{ end }}

      - name: Use vars
        id: vars_enabled
        run: |
          if [ "${{"{{"}} vars[env.ENABLED_NAME] {{"}}"}}" == "ENABLED" ]; then
            echo "ENABLE_BUILD=true" >> $GITHUB_OUTPUT
{{- if .Artifacts.HasDocker }}
            echo "ENABLE_DEPLOY=true" >> $GITHUB_OUTPUT
{{- end }}
          elif [ "${{"{{"}} vars[env.ENABLED_NAME] {{"}}"}}" == "ENABLED_ONLY_BUILD" ]; then
            echo "ENABLE_BUILD=true" >> $GITHUB_OUTPUT
{{- if .Artifacts.HasDocker }}
            echo "ENABLE_DEPLOY=false" >> $GITHUB_OUTPUT
            echo "DEPLOY_ENVS=[]" >> $GITHUB_OUTPUT
{{- end }}
          else
            echo "Skip branch ${GITHUB_REF}"
            echo "ENABLE_BUILD=false" >> $GITHUB_OUTPUT
{{- if .Artifacts.HasDocker }}
            echo "ENABLE_DEPLOY=false" >> $GITHUB_OUTPUT
            echo "DEPLOY_ENVS=[]" >> $GITHUB_OUTPUT
{{- end }}
            exit 0
          fi

{{ if .Artifacts.HasDocker }}
      - name: Deploy vars
        id: vars_deploy
        if: steps.vars_enabled.outputs.ENABLE_DEPLOY == 'true'
        run: |
          if [ -z "${{"{{"}} vars[env.SSH_HOST_NAME] {{"}}"}}" ]; then
            echo "Empty SSH_HOST"
            exit 1
          fi

          echo 'SSH_HOST_MATRIX=${{"{{"}} vars[env.SSH_HOST_NAME] {{"}}"}}' >> $GITHUB_OUTPUT

          if [ -z "${{"{{"}} vars[env.OC_HOST_NAME] {{"}}"}}" ]; then
            echo "Empty OC_HOST"
            exit 2
          fi
          echo 'OC_HOST=${{"{{"}} vars[env.OC_HOST_NAME] {{"}}"}}' >> $GITHUB_OUTPUT

          if [ -z "${{"{{"}} vars[env.OC_PORT_NAME] {{"}}"}}" ]; then
            echo "Empty OC_PORT use 443"
            echo 'OC_PORT=443' >> $GITHUB_OUTPUT
          else
            echo 'OC_PORT=${{"{{"}} vars[env.OC_PORT_NAME] {{"}}"}}' >> $GITHUB_OUTPUT
          fi

          if [ -z "${{"{{"}} vars[env.INTERNAL_SUBNET_NAME] {{"}}"}}" ]; then
            echo "Empty INTERNAL_SUBNET"
            exit 2
          fi
          echo 'INTERNAL_SUBNET=${{"{{"}} vars[env.INTERNAL_SUBNET_NAME] {{"}}"}}' >> $GITHUB_OUTPUT

          LEN_EXPECTED=$(echo '${{"{{"}} vars[env.ENV_TYPE_NAME] {{"}}"}}' | jq '. | length')
          if [ -z "$LEN_EXPECTED" ]; then
            LEN_EXPECTED=1
          fi

          echo "LEN_EXPECTED=$LEN_EXPECTED" >> $GITHUB_OUTPUT
          echo DEPLOY_ENVS="`jq -cn "[range(0; $LEN_EXPECTED)]"`" >> $GITHUB_OUTPUT
{{ end }}

{{ if .Artifacts.HasDocker }}
      - name: Check and set vars for instances
        id: set_env_main
        if: steps.vars_enabled.outputs.ENABLE_DEPLOY == 'true'

        run: |
          LEN_EXPECTED=${{"{{"}} steps.vars_deploy.outputs.LEN_EXPECTED {{"}}"}}

          {{- range $_, $a := .Applications }}{{ if $a.HasDocker }}
            if [ -z "${{"{{"}} vars[env.PORT_PREFIX_{{ $a.Name | ToUpper | ReplaceDash }}_TRAEFIK_NAME] {{"}}"}}" ]; then
              echo "Empty variable ${{"{{"}} env.PORT_PREFIX_{{ $a.Name | ToUpper | ReplaceDash }}_TRAEFIK_NAME {{"}}"}}"
              exit 3
            fi

            LEN=$(echo '${{"{{"}} vars[env.PORT_PREFIX_{{ $a.Name | ToUpper | ReplaceDash }}_TRAEFIK_NAME] {{"}}"}}' | jq '. | length')

            if [ "$LEN" != "$LEN_EXPECTED" ]; then
              echo "Invalid array size ${{"{{"}} env.PORT_PREFIX_{{ $a.Name | ToUpper | ReplaceDash }}_TRAEFIK_NAME {{"}}"}}: $LEN"
              exit 4
            fi

            echo 'PORT_PREFIX_{{ $a.Name | ToUpper | ReplaceDash }}_TRAEFIK=${{"{{"}} vars[env.PORT_PREFIX_{{ $a.Name | ToUpper | ReplaceDash}}_TRAEFIK_NAME] {{"}}"}}' >> $GITHUB_OUTPUT

            {{- range $_, $t := $a.GetRestTransport }}{{ if ne $t.GeneratorType "ogen_client" }}
            {{ if $t.PublicService }}
          if [ -z "${{"{{"}} vars[env.DOMAIN_{{ $t.Name | ToUpper }}_NAME] {{"}}"}}" ]; then
            echo "Empty variable ${{"{{"}} env.DOMAIN_{{ $t.Name | ToUpper }}_NAME {{"}}"}}"
            exit 5
          fi

          LEN=$(echo '${{"{{"}} vars[env.DOMAIN_{{ $t.Name | ToUpper }}_NAME] {{"}}"}}' | jq '. | length')

          if [ "$LEN" != "$LEN_EXPECTED" ]; then
            echo "Invalid array size ${{"{{"}} env.DOMAIN_{{ $t.Name | ToUpper }}_NAME {{"}}"}}: $LEN"
            exit 6
          fi

          echo 'DOMAIN_{{ $t.Name | ToUpper }}=${{"{{"}} vars[env.DOMAIN_{{ $t.Name | ToUpper }}_NAME] {{"}}"}}' >> $GITHUB_OUTPUT
            {{ end }}
          if [ -z "${{"{{"}} vars[env.PORT_PREFIX_{{ $a.Name | ToUpper | ReplaceDash }}_{{ $t.Name | ToUpper }}_NAME] {{"}}"}}" ]; then
            echo "Empty variable ${{"{{"}} env.PORT_PREFIX_{{ $a.Name | ToUpper | ReplaceDash }}_{{ $t.Name | ToUpper }}_NAME {{"}}"}}"
            exit 3
          fi

          LEN=$(echo '${{"{{"}} vars[env.PORT_PREFIX_{{ $a.Name | ToUpper | ReplaceDash }}_{{ $t.Name | ToUpper }}_NAME] {{"}}"}}' | jq '. | length')

          if [ "$LEN" != "$LEN_EXPECTED" ]; then
            echo "Invalid array size ${{"{{"}} env.PORT_PREFIX_{{ $a.Name | ToUpper | ReplaceDash }}_{{ $t.Name | ToUpper }}_NAME {{"}}"}}: $LEN"
            exit 4
          fi

          echo 'PORT_PREFIX_{{ $a.Name | ToUpper | ReplaceDash }}_{{ $t.Name | ToUpper }}=${{"{{"}} vars[env.PORT_PREFIX_{{ $a.Name | ToUpper | ReplaceDash}}_{{ $t.Name | ToUpper }}_NAME] {{"}}"}}' >> $GITHUB_OUTPUT
            {{ end -}}{{ end -}}
          {{ end }}{{ end -}}

          LEN=$(echo '${{"{{"}} vars[env.ENV_TYPE_NAME] {{"}}"}}' | jq '. | length')

          if [ "$LEN" != "$LEN_EXPECTED" ]; then
            echo "Invalid array size ${{"{{"}} env.ENV_TYPE_NAME {{"}}"}}: $LEN"
            exit 7
          fi

          echo 'ENV_TYPE=${{"{{"}} vars[env.ENV_TYPE_NAME] {{"}}"}}' >> $GITHUB_OUTPUT

          if [ -z "${{"{{"}} secrets[env.OC_USER_NAME] {{"}}"}}" ]; then
            echo "Empty secrets ${{"{{"}} env.OC_USER_NAME {{"}}"}}"
            exit 8
          fi

          LEN=$(echo '${{"{{"}} secrets[env.OC_USER_NAME] {{"}}"}}' | jq '. | length')

          if [ "$LEN" != "$LEN_EXPECTED" ]; then
            echo "Invalid array size ${{"{{"}} env.OC_USER_NAME {{"}}"}}: $LEN"
            exit 9
          fi

          echo 'OC_USER=${{"{{"}} env.OC_USER_NAME {{"}}"}}' >> $GITHUB_OUTPUT

          if [ -z "${{"{{"}} secrets[env.OC_PASSWORD_NAME] {{"}}"}}" ]; then
            echo "Empty secrets ${{"{{"}} env.OC_PASSWORD_NAME {{"}}"}}"
            exit 10
          fi
          LEN=$(echo '${{"{{"}} secrets[env.OC_PASSWORD_NAME] {{"}}"}}' | jq '. | length')

          if [ "$LEN" != "$LEN_EXPECTED" ]; then
            echo "Invalid array size ${{"{{"}} env.OC_PASSWORD_NAME {{"}}"}}: $LEN"
            exit 11
          fi

          echo 'OC_PASSWORD=${{"{{"}} env.OC_PASSWORD_NAME {{"}}"}}' >> $GITHUB_OUTPUT
{{ end }}

      - name: Checkout repository
        if: steps.vars_enabled.outputs.ENABLE_BUILD == 'true'
        uses: actions/checkout@v3

      - name: "Version and containers"
        id: vers_and_containers
        if: steps.vars_enabled.outputs.ENABLE_BUILD == 'true'
        run: |
          vers=$(make release-tag)
          echo "RELEASE=$vers" >> $GITHUB_OUTPUT
{{- if .Artifacts.HasDocker }}
          containerList=$(make docker-list)
          echo "CONTAINERS=$containerList" >> $GITHUB_OUTPUT
          art=$(make artifact-list)
          echo "ARTIFACTS=$art" >> $GITHUB_OUTPUT
{{- end }}
{{- if .Artifacts.HasPackaging }}
          pkg=$(make package-list)
          echo "PACKAGES=$pkg" >> $GITHUB_OUTPUT
{{- end }}
{{ if .Artifacts.HasDocker }}
      - name: Upload env file
        uses: actions/upload-artifact@v4
        if: steps.vars_enabled.outputs.ENABLE_DEPLOY == 'true'
        with:
          name: envs-docker
          path: docker-compose-*.yaml
          retention-days: 1
          overwrite: true
{{ end }}

{{ if .Artifacts.HasDocker }}
  create_env_files:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        envs: ${{"{{"}} fromJSON(needs.prepare-env.outputs.DEPLOY_ENVS) {{"}}"}}
    needs:
      - prepare-env
    if: needs.prepare-env.outputs.ENABLE_DEPLOY == 'true'
    steps:
      - name: Create env file
        id: create_env_file
        run: |
          fname=".env."${{"{{"}} github.ref_name {{"}}"}}

          ENV_TYPE=${{"{{"}} fromJSON(needs.prepare-env.outputs.ENV_TYPE)[matrix.envs] {{"}}"}}
          if [ ! -z "$ENV_TYPE" ]; then
            fname="$fname-$ENV_TYPE"
          fi

          {{- range $_, $a := .Applications }}{{ if $a.HasDocker }}
          echo 'PORT_PREFIX_{{ $a.Name | ToUpper | ReplaceDash }}_TRAEFIK="${{"{{"}} fromJson(needs.prepare-env.outputs.PORT_PREFIX_{{ $a.Name | ToUpper | ReplaceDash }}_TRAEFIK)[matrix.envs] {{"}}"}}"' >> $fname
            {{- range $_, $t := $a.GetRestTransport }}{{ if ne $t.GeneratorType "ogen_client" }}
              {{ if $t.PublicService }}
          echo 'DOMAIN_{{ $t.Name | ToUpper }}="${{"{{"}} fromJson(needs.prepare-env.outputs.DOMAIN_{{ $t.Name | ToUpper }})[matrix.envs] {{"}}"}}"' >> $fname
              {{ end }}
          echo 'PORT_PREFIX_{{ $a.Name | ToUpper | ReplaceDash }}_{{ $t.Name | ToUpper }}="${{"{{"}} fromJson(needs.prepare-env.outputs.PORT_PREFIX_{{ $a.Name | ToUpper | ReplaceDash }}_{{ $t.Name | ToUpper }})[matrix.envs] {{"}}"}}"' >> $fname
            {{- end }}{{- end }}
          {{- end }}{{ end }}
          echo "ENV_TYPE=$ENV_TYPE" >> $fname
          echo 'OC_HOST="${{"{{"}} needs.prepare-env.outputs.OC_HOST {{"}}"}}"' >> $fname
          echo 'OC_PORT="${{"{{"}} needs.prepare-env.outputs.OC_PORT {{"}}"}}"' >> $fname
          echo 'OC_USER="${{"{{"}} fromJson(secrets[needs.prepare-env.outputs.OC_USER])[matrix.envs] {{"}}"}}"' >> $fname
          echo 'OC_PASSWORD="${{"{{"}} fromJson(secrets[needs.prepare-env.outputs.OC_PASSWORD])[matrix.envs] {{"}}"}}"' >> $fname
          echo 'APP_VERSION="${{"{{"}} needs.prepare-env.outputs.RELEASE {{"}}"}}"' >> $fname
          echo 'REGISTRY_SERVER=${{"{{"}} secrets.REGISTRY_LOGIN_SERVER {{"}}"}}/${{"{{"}} vars.REGISTRY_CONTAINER {{"}}"}}' >> $fname
          echo 'INTERNAL_SUBNET=${{"{{"}} needs.prepare-env.outputs.INTERNAL_SUBNET {{"}}"}}' >> $fname


          # ToDo add file encriptions
          echo "Generated $fname"
          echo "FNAME=$fname" >> $GITHUB_OUTPUT

      - name: Upload env file
        uses: actions/upload-artifact@v4
        with:
          name: envs-${{"{{"}} matrix.envs {{"}}"}}
          path: ${{"{{"}} steps.create_env_file.outputs.FNAME {{"}}"}}
          retention-days: 1
          include-hidden-files: true
          overwrite: true

{{ range $_, $a := .Applications }}{{ if $a.GoatTests }}
  run-goat-tests-{{ $a.Name | ReplaceDash }}:
    runs-on: ubuntu-latest
    needs:
      - prepare-env
    if: needs.prepare-env.outputs.ENABLE_BUILD == 'true' && vars.SKIP_GOAT_TESTS != 'true'
    permissions:
      contents: read
      packages: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '{{ $.GoLangVersion }}'
          cache: true

      {{ if eq $.RegistryType "github" }}
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{"{{"}} secrets.GHCR_USER {{"}}"}}
          password: ${{"{{"}} secrets.GHCR_TOKEN {{"}}"}}
      {{ else if eq $.RegistryType "digitalocean" }}
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{"{{"}} secrets.REGISTRY_PASSWORD {{"}}"}}

      - name: Log in to DO Container Registry
        run: doctl registry login
      {{ else if eq $.RegistryType "aws" }}
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{"{{"}} secrets.AWS_ACCESS_KEY_ID {{"}}"}}
          aws-secret-access-key: ${{"{{"}} secrets.AWS_SECRET_ACCESS_KEY {{"}}"}}
          aws-region: ${{"{{"}} secrets.AWS_REGION {{"}}"}}

      - name: Log in to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
      {{ else if eq $.RegistryType "selfhosted" }}
      - name: Log in to Docker Registry
        uses: docker/login-action@v2
        with:
          registry: ${{"{{"}} secrets.REGISTRY_URL {{"}}"}}
          username: ${{"{{"}} secrets.REGISTRY_USERNAME {{"}}"}}
          password: ${{"{{"}} secrets.REGISTRY_PASSWORD {{"}}"}}
      {{ end }}

      - name: Configure Git for private repos
        env:
          GH_TOKEN: ${{"{{"}} secrets.GH_PAT {{"}}"}}
        run: |
          git config --global url."https://x-access-token:${GH_TOKEN}@github.com/".insteadOf "https://github.com/"

      - name: Set GOPRIVATE
        run: |
          go env -w GOPRIVATE="github.com/Educentr{{ if $.PrivateRepos }},{{ $.PrivateRepos }}{{ end }}"

      - name: Run GOAT tests for {{ $a.Name }}
        run: |
          make goat-tests-{{ $a.Name }}

      - name: Report GOAT tests status
        uses: act10ns/slack@v2
        if: failure()
        with:
          status: ${{"{{"}} job.status {{"}}"}}
          steps: ${{"{{"}} toJson(steps) {{"}}"}}
        env:
          SLACK_WEBHOOK_URL: ${{"{{"}} secrets.ACTION_MONITORING_SLACK {{"}}"}}
{{ end }}{{ end }}

  build:
    runs-on: ubuntu-latest
    needs:
      - prepare-env
{{ range $_, $a := .Applications }}{{ if $a.GoatTests }}      - run-goat-tests-{{ $a.Name | ReplaceDash }}
{{ end }}{{ end }}    strategy:
      matrix:
        containers: ${{"{{"}} fromJSON(needs.prepare-env.outputs.CONTAINERS) {{"}}"}}
    if: |
      always() &&
      needs.prepare-env.outputs.ENABLE_BUILD == 'true' &&
      needs.prepare-env.result == 'success'{{ range $_, $a := .Applications }}{{ if $a.GoatTests }} &&
      (needs.run-goat-tests-{{ $a.Name | ReplaceDash }}.result == 'success' || needs.run-goat-tests-{{ $a.Name | ReplaceDash }}.result == 'skipped'){{ end }}{{ end }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      {{ if eq .RegistryType "digitalocean" }}
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{"{{"}} secrets.REGISTRY_PASSWORD {{"}}"}}

      - name: Log in to DO Container Registry
        run: doctl registry login
      {{ else if eq .RegistryType "github" }}
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{"{{"}} secrets.GHCR_USER {{"}}"}}
          password: ${{"{{"}} secrets.GHCR_TOKEN {{"}}"}}
      {{ else if eq .RegistryType "aws" }}
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{"{{"}} secrets.AWS_ACCESS_KEY_ID {{"}}"}}
          aws-secret-access-key: ${{"{{"}} secrets.AWS_SECRET_ACCESS_KEY {{"}}"}}
          aws-region: ${{"{{"}} secrets.AWS_REGION {{"}}"}}

      - name: Log in to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
      {{ else if eq .RegistryType "selfhosted" }}
      - name: Log in to Docker Registry
        uses: docker/login-action@v2
        with:
          registry: ${{"{{"}} secrets.REGISTRY_URL {{"}}"}}
          username: ${{"{{"}} secrets.REGISTRY_USERNAME {{"}}"}}
          password: ${{"{{"}} secrets.REGISTRY_PASSWORD {{"}}"}}
      {{ else }}
        {{ .UndefinedRegistryTypeError .RegistryType }}
      {{ end }}
      - name: Configure Git for private repos
        env:
          # Use PAT if available, otherwise use GITHUB_TOKEN
          GITHUB_TOKEN: ${{"{{"}} secrets.GH_PAT {{"}}"}}
        run: |
          git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
      - name: "Build and push"
        id: build_and_push
        env:
          REGISTRY_SERVER: ${{"{{"}} secrets.REGISTRY_LOGIN_SERVER {{"}}"}}/${{"{{"}} vars.REGISTRY_CONTAINER {{"}}"}}
          GITHUB_TOKEN: ${{"{{"}} secrets.GH_PAT {{"}}"}}
        run: |
          make ${{"{{"}} matrix.containers {{"}}"}}
          make ${{"{{"}} matrix.containers {{"}}"}}-push

      - name: Report Build status
        uses: act10ns/slack@v2
        if: failure()
        with:
          status: ${{"{{"}} job.status {{"}}"}}
          steps: ${{"{{"}} toJson(steps) {{"}}"}}
          matrix: ${{"{{"}} toJson(matrix) {{"}}"}}
        env:
          SLACK_WEBHOOK_URL: ${{"{{"}} secrets.ACTION_MONITORING_SLACK {{"}}"}}
{{ end }}

{{ if .Artifacts.HasPackaging }}
  build-packages:
    runs-on: ubuntu-latest
    needs:
      - prepare-env
{{ range $_, $a := .Applications }}{{ if $a.GoatTests }}      - run-goat-tests-{{ $a.Name | ReplaceDash }}
{{ end }}{{ end }}    if: |
      always() &&
      needs.prepare-env.outputs.ENABLE_BUILD == 'true' &&
      needs.prepare-env.result == 'success'{{ range $_, $a := .Applications }}{{ if $a.GoatTests }} &&
      (needs.run-goat-tests-{{ $a.Name | ReplaceDash }}.result == 'success' || needs.run-goat-tests-{{ $a.Name | ReplaceDash }}.result == 'skipped'){{ end }}{{ end }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '{{ .GoLangVersion }}'
          cache: true

      - name: Configure Git for private repos
        env:
          GH_TOKEN: ${{"{{"}} secrets.GH_PAT {{"}}"}}
        run: |
          git config --global url."https://x-access-token:${GH_TOKEN}@github.com/".insteadOf "https://github.com/"

      - name: Set GOPRIVATE
        run: |
          go env -w GOPRIVATE="github.com/Educentr{{ if .PrivateRepos }},{{ .PrivateRepos }}{{ end }}"

      - name: Install nfpm
        run: go install github.com/goreleaser/nfpm/v2/cmd/nfpm@latest

      - name: Build packages
        run: make packages

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: packages
          path: |
            {{- if .Artifacts.HasDeb }}
            *.deb
            {{- end }}
            {{- if .Artifacts.HasRPM }}
            *.rpm
            {{- end }}
            {{- if .Artifacts.HasAPK }}
            *.apk
            {{- end }}

{{ if .Artifacts.HasUpload }}
  # Upload packages to storage
  # Required repository variables/secrets:
  {{- if .Artifacts.IsMinio }}
  #   secrets.MINIO_ACCESS_KEY, secrets.MINIO_SECRET_KEY - MinIO credentials
  #   vars.UPLOAD_ENDPOINT - MinIO endpoint URL (e.g., https://minio.example.com)
  #   vars.UPLOAD_BUCKET - Target bucket name
  #   vars.UPLOAD_PREFIX - Path prefix in bucket (optional, default: packages)
  {{- else if .Artifacts.IsAWS }}
  #   secrets.AWS_ACCESS_KEY_ID, secrets.AWS_SECRET_ACCESS_KEY - AWS credentials
  #   vars.UPLOAD_BUCKET - Target S3 bucket name
  #   vars.UPLOAD_REGION - Bucket region (optional, default: us-east-1)
  #   vars.UPLOAD_PREFIX - Path prefix in bucket (optional, default: packages)
  {{- else if .Artifacts.IsRsync }}
  #   secrets.UPLOAD_SSH_PRIVATE_KEY - SSH private key for rsync
  #   vars.UPLOAD_HOST - Target SSH host
  #   vars.UPLOAD_USER - SSH username
  #   vars.UPLOAD_PATH - Remote path for packages
  {{- end }}
  upload-packages:
    runs-on: ubuntu-latest
    needs:
      - build-packages
    if: needs.prepare-env.outputs.ENABLE_BUILD == 'true'
    steps:
      - name: Download packages
        uses: actions/download-artifact@v4
        with:
          name: packages
          path: ./packages

      {{- if .Artifacts.IsMinio }}
      - name: Install MinIO Client
        run: |
          curl -sSL https://dl.min.io/client/mc/release/linux-amd64/mc -o /usr/local/bin/mc
          chmod +x /usr/local/bin/mc

      - name: Configure MinIO Client
        run: |
          mc alias set minio ${{"{{"}} vars.UPLOAD_ENDPOINT {{"}}"}} ${{"{{"}} secrets.MINIO_ACCESS_KEY {{"}}"}} ${{"{{"}} secrets.MINIO_SECRET_KEY {{"}}"}}

      - name: Upload to MinIO
        run: |
          mc cp ./packages/* minio/${{"{{"}} vars.UPLOAD_BUCKET {{"}}"}}/${{"{{"}} vars.UPLOAD_PREFIX || 'packages' {{"}}"}}/
      {{- else if .Artifacts.IsAWS }}
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{"{{"}} secrets.AWS_ACCESS_KEY_ID {{"}}"}}
          aws-secret-access-key: ${{"{{"}} secrets.AWS_SECRET_ACCESS_KEY {{"}}"}}
          aws-region: ${{"{{"}} vars.UPLOAD_REGION || 'us-east-1' {{"}}"}}

      - name: Upload to AWS S3
        run: |
          aws s3 cp ./packages/ s3://${{"{{"}} vars.UPLOAD_BUCKET {{"}}"}}/${{"{{"}} vars.UPLOAD_PREFIX || 'packages' {{"}}"}}/ \
            --recursive
      {{- else if .Artifacts.IsRsync }}
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{"{{"}} secrets.UPLOAD_SSH_PRIVATE_KEY {{"}}"}}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{"{{"}} vars.UPLOAD_HOST {{"}}"}} >> ~/.ssh/known_hosts

      - name: Upload via rsync
        run: |
          rsync -avz --progress ./packages/ \
            ${{"{{"}} vars.UPLOAD_USER {{"}}"}}@${{"{{"}} vars.UPLOAD_HOST {{"}}"}}:${{"{{"}} vars.UPLOAD_PATH {{"}}"}}/
      {{- end }}

      - name: Report Upload status
        uses: act10ns/slack@v2
        if: failure()
        with:
          status: ${{"{{"}} job.status {{"}}"}}
          steps: ${{"{{"}} toJson(steps) {{"}}"}}
        env:
          SLACK_WEBHOOK_URL: ${{"{{"}} secrets.ACTION_MONITORING_SLACK {{"}}"}}
{{ end }}
{{ end }}

{{ if .Artifacts.HasDocker }}
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ips: ${{"{{"}} fromJSON(needs.prepare-env.outputs.SSH_HOST_MATRIX) {{"}}"}}
    needs:
      - build
      - create_env_files
      - prepare-env
{{- range $_, $a := .Applications }}{{ if $a.UseEnvs }}
      - create_{{ $a.Name | ReplaceDash }}_env_files
{{- end }}{{- end }}
    if: needs.prepare-env.outputs.ENABLE_DEPLOY == 'true'
    steps:
      - name: Download env file
        uses: actions/download-artifact@v4

      - name: Modify env file
        run: |
          for f in $(ls envs-*/.env.*); do
            echo "Processing file: $f"
            echo "INTERNAL_LAN=${{"{{"}} matrix.ips[1] {{"}}"}}" >> $f
          done

      - name: Deploy to Server
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{"{{"}} secrets.SSH_PRIVATE_KEY {{"}}"}}
          ARGS: '-rlgoDzvcb -i --delete --backup-dir="../envs_bak" --suffix=`date "+%F_%R"`'
          SOURCE: "./envs*/"
          REMOTE_HOST: ${{"{{"}} matrix.ips[0] {{"}}"}}
          REMOTE_USER: ${{"{{"}} secrets.SSH_USER {{"}}"}}
          TARGET: /opt/{{ .ProjectName }}-cd/envs
          SCRIPT_AFTER_REQUIRED: true
          SCRIPT_AFTER: |
            cd /opt/{{ .ProjectName }}-cd;
            mv envs/docker-compose-*.yaml ./;
            ./deploy.sh || exit 1;
            echo $RSYNC_STDOUT;

      - name: Report Deploy status
        uses: act10ns/slack@v2
        with:
          status: ${{"{{"}} job.status {{"}}"}}
          steps: ${{"{{"}} toJson(steps) {{"}}"}}
          matrix: ${{"{{"}} toJson(matrix) {{"}}"}}
        env:
          SLACK_WEBHOOK_URL: ${{"{{"}} secrets.ACTION_MONITORING_SLACK {{"}}"}}
{{ end }}

  artifact_version:
    runs-on: ubuntu-latest
    needs:
      - prepare-env
{{- if .Artifacts.HasDocker }}
      - build
{{- end }}
{{- if .Artifacts.HasPackaging }}
      - build-packages
{{- end }}
    if: always() && needs.prepare-env.outputs.ENABLE_BUILD == 'true'
    env:
      TELEGRAM_BOT_TOKEN: ${{"{{"}} secrets.TELEGRAM_BOT_TOKEN {{"}}"}}
      TELEGRAM_CHAT_ID: ${{"{{"}} secrets.TELEGRAM_CHAT_ID {{"}}"}}

    steps:
      - name: Check conditions and set message
        run: |
          BRANCH="${{"{{"}} github.ref_name {{"}}"}}"
{{- if .Artifacts.HasDocker }}
          BUILD_STATUS="${{"{{"}} needs.build.result {{"}}"}}"
{{- end }}
{{- if .Artifacts.HasPackaging }}
          PACKAGES_STATUS="${{"{{"}} needs.build-packages.result {{"}}"}}"
{{- end }}
          COMMIT_MSG="${{"{{"}} github.event.head_commit.message {{"}}"}}"
          RUN_URL="https://github.com/${{"{{"}} github.repository {{"}}"}}/actions/runs/${{"{{"}} github.run_id {{"}}"}}"

          # Проверка секретов
          if [[ -z "$TELEGRAM_BOT_TOKEN" || -z "$TELEGRAM_CHAT_ID" ]]; then
            echo "MESSAGE=" >> $GITHUB_ENV
            exit 0
          fi

          # Проверка ветки
          if [[ "$BRANCH" != "main" && "$BRANCH" != "staging" ]]; then
            echo "MESSAGE=" >> $GITHUB_ENV
            exit 0
          fi

          # Определяем общий статус
          STATUS="success"
{{- if .Artifacts.HasDocker }}
          if [[ "$BUILD_STATUS" != "success" ]]; then
            STATUS="failure"
          fi
{{- end }}
{{- if .Artifacts.HasPackaging }}
          if [[ "$PACKAGES_STATUS" != "success" ]]; then
            STATUS="failure"
          fi
{{- end }}

          # Экранируем commit message для MarkdownV2 (берём только первую строку)
          # Символы для экранирования: _ * [ ] ( ) ~ ` > # + - = | { } . !
          ESCAPED_COMMIT_MSG=$(echo "$COMMIT_MSG" | head -1 | sed 's/[][_*()~`>#+=|{}.!-]/\\&/g')

          # Формирование сообщения
          MESSAGE="Репозиторий: *$(echo "${{"{{"}} github.repository {{"}}"}}" | sed 's/[][_*()~`>#+=|{}.!-]/\\&/g')*
          Коммит: _${ESCAPED_COMMIT_MSG}_"

          if [[ "$STATUS" == "success" ]]; then
            MESSAGE="$MESSAGE
            ✅ Успех: *${{"{{"}} github.workflow {{"}}"}}* завершен на ветке *$BRANCH*"
{{- if .Artifacts.HasDocker }}
            DOCKER_VERS=$(echo '${{"{{"}} needs.prepare-env.outputs.ARTIFACTS {{"}}"}}' | jq -r '.[]' | sed 's/[][_*()~`>#+=|{}.!-]/\\&/g')
            MESSAGE="$MESSAGE

            *Docker образы:*
            ${DOCKER_VERS}"
{{- end }}
{{- if .Artifacts.HasPackaging }}
            PKG_VERS=$(echo '${{"{{"}} needs.prepare-env.outputs.PACKAGES {{"}}"}}' | jq -r '.[]' | sed 's/[][_*()~`>#+=|{}.!-]/\\&/g')
            MESSAGE="$MESSAGE

            *Пакеты:*
            ${PKG_VERS}"
{{- end }}
          else
            MESSAGE="$MESSAGE
            ❌ Ошибка: *${{"{{"}} github.workflow {{"}}"}}* завершился с ошибкой на ветке *$BRANCH*"
          fi

          MESSAGE="$MESSAGE
          [Посмотреть билд](${RUN_URL})"

          curl -s -X POST https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage \
            -d chat_id=$TELEGRAM_CHAT_ID \
            -d text="$MESSAGE" \
            -d parse_mode="MarkdownV2"
