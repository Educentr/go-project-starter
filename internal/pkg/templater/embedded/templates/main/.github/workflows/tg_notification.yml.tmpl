name: Telegram Notification

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      TELEGRAM_BOT_TOKEN: ${{"{{"}} secrets.TELEGRAM_BOT_TOKEN {{"}}"}}
      TELEGRAM_CHAT_ID: ${{"{{"}} secrets.TELEGRAM_CHAT_ID {{"}}"}}
    steps:
      - name: Check conditions and set message
        run: |
          BRANCH="${{"{{"}} github.event.workflow_run.head_branch {{"}}"}}"
          STATUS="${{"{{"}} github.event.workflow_run.conclusion {{"}}"}}"
          COMMIT_MSG="${{"{{"}} github.event.workflow_run.head_commit.message {{"}}"}}"
          RUN_URL="https://github.com/${{"{{"}} github.repository {{"}}"}}/actions/runs/${{"{{"}} github.event.workflow_run.id {{"}}"}}"

          # Проверка секретов
          if [[ -z "$TELEGRAM_BOT_TOKEN" || -z "$TELEGRAM_CHAT_ID" ]]; then
            echo "MESSAGE=" >> $GITHUB_ENV
            exit 0
          fi

          # Проверка ветки
          if [[ "$BRANCH" != "main" && "$BRANCH" != "staging" ]]; then
            echo "MESSAGE=" >> $GITHUB_ENV
            exit 0
          fi

          ESCAPED_COMMIT_MSG=$(echo "$COMMIT_MSG" | sed -e 's/[_*[\]()~`]/\\&/g')

          # Формирование сообщения
          if [[ "$STATUS" == "success" ]]; then
            MESSAGE="✅ Успех: *${{"{{"}} github.workflow {{"}}"}}* завершен на ветке *$BRANCH*.\nКоммит: _${ESCAPED_COMMIT_MSG}_\n[Посмотреть билд]($RUN_URL)"
          else
            MESSAGE="❌ Ошибка: *${{"{{"}} github.workflow {{"}}"}}* завершился с ошибкой на ветке *$BRANCH*.\nКоммит: _${ESCAPED_COMMIT_MSG}_\n[Посмотреть билд]($RUN_URL)"
          fi

          echo "MESSAGE=$MESSAGE" >> $GITHUB_ENV

      - name: Send Telegram message
        if: env.MESSAGE != ''
        run: |
          curl -s -X POST https://api.telegram.org/bot${{"{{"}} env.TELEGRAM_BOT_TOKEN {{"}}"}}/sendMessage \
            -d chat_id=${{"{{"}} env.TELEGRAM_CHAT_ID {{"}}"}} \
            -d text="${{"{{"}} env.MESSAGE {{"}}"}}" \
            -d parse_mode="Markdown"