FROM golang:{{ .GoLangVersion }}-alpine AS builder
ARG binary=bin/{{ .Application.Name }}
ARG GOPROXY

RUN set -xe  && \
    apk update && apk upgrade  && \
    apk add --no-cache make git
ENV CGO_ENABLED=0
COPY . /go/src/app
WORKDIR /go/src/app

# Configure Git to use GitHub token for private repos
RUN --mount=type=secret,id=github_token \
    if [ -f /run/secrets/github_token ]; then \
        export GITHUB_TOKEN=$(cat /run/secrets/github_token) && \
        git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"{{- if .PrivateRepos }} && \
        go env -w GOPRIVATE="{{ .PrivateRepos }}"{{- end }}; \
    fi && \
    make build_in_docker-{{ .Application.Name }} && \
    cp ${binary} /service

RUN mkdir -p /public 
ADD public /public
RUN chmod -R 755 /public

FROM alpine
COPY --from=builder /service /service
COPY --from=builder /public /public
RUN mkdir -p /etc/onlineconf
CMD ["/service"]

{{- range $_, $t := .Applications.GetRestTransport }}
# {{ $t.Name }}/{{ $t.Type }}
EXPOSE {{ $t.Port }}
{{- end }}
