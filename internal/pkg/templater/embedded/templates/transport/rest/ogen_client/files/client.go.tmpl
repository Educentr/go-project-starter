package {{ .Transport.Name }}

import (
	"context"
	"net/http"
	"time"

	"github.com/Educentr/go-onlineconf/pkg/onlineconf"
	"github.com/pkg/errors"
	"go.opentelemetry.io/otel/attribute"

	"{{ .ProjectPath }}/internal/app/constant"
	"{{ .ProjectPath }}/pkg/app/rest"
	{{ .Transport.PkgName }} "{{ .ProjectPath }}/pkg/rest/{{ .Transport.Name }}/v1"
)

type Client struct {
	rest.DefaultClient
}

func NewClient() Client {
	return Client{}
}

func (c *Client) GetClient{{ .Transport.Name }}(ctx context.Context) (*{{ .Transport.PkgName }}.Client, error) {
	url, ex, err := onlineconf.GetStringIfExists(ctx, onlineconf.MakePath(constant.ServiceName, "transport", "rest", "{{ .Transport.PkgName }}", "host"))
	if err != nil {
		return nil, errors.Wrap(err, "error getting {{ .Transport.PkgName }} url")
	}

	if !ex || url == "" {
		{{ if .Transport.EmptyConfigAvailable -}}
		return nil, nil
		{{- else -}}
		return nil, errors.New("{{ .Transport.PkgName }} client URL not configured")
		{{- end }}
	}

	timeout, err := onlineconf.GetDuration(ctx, onlineconf.MakePath(constant.ServiceName, "transport", "rest", "{{ .Transport.PkgName }}", "timeout"), time.Second * 2)
	if err != nil {
		return nil, errors.Wrap(err, "error getting {{ .Transport.PkgName }} url")
	}

	return {{ .Transport.PkgName }}.NewClient(
		url,
        {{ if and (eq .Transport.AuthParams.Transport "header") (eq .Transport.AuthParams.Type "apikey")}}
		&SecuritySource{},
        {{ end }}
		{{ .Transport.PkgName }}.WithClient(&http.Client{
			Timeout: timeout,
			Transport: rest.Chain(http.DefaultTransport,
				c.GetClientMiddlewares(ctx, constant.ServiceName, nil, nil, "{{ .Transport.PkgName }}", nil)...,
			),
		}),
		{{ .Transport.PkgName }}.WithAttributes(
			attribute.String("client_name", "{{ .Transport.Name }}"),
			attribute.String("service_name", constant.ServiceName),
		),
	)
}
