package {{ .Kafka.Name | ToLower }}

import (
	"context"
	"fmt"
	"time"

	"github.com/segmentio/kafka-go"
	zlog "github.com/rs/zerolog"
{{- $hasSchema := false }}
{{- range $_, $topic := .Kafka.Topics }}
{{- if $topic.GoType }}{{ $hasSchema = true }}{{ end }}
{{- end }}
{{- if $hasSchema }}
	"encoding/json"
{{- end }}
{{- range $_, $topic := .Kafka.Topics }}
{{- if $topic.GoImport }}
	"{{ $topic.GoImport }}"
{{- end }}
{{- end }}
)

{{ range $_, $topic := .Kafka.Topics }}
// Publish{{ $topic.ID | Capitalize | ReplaceDash }} sends a message to topic "{{ $topic.ID }}" (default: {{ $topic.Name }})
{{- if $topic.GoType }}
func (p *Producer) Publish{{ $topic.ID | Capitalize | ReplaceDash }}(ctx context.Context, key []byte, msg {{ $topic.GoType }}) error {
{{- else }}
func (p *Producer) Publish{{ $topic.ID | Capitalize | ReplaceDash }}(ctx context.Context, key []byte, msg []byte) error {
{{- end }}
	if p.disabled {
		zlog.Ctx(ctx).Warn().Str("producer", "{{ $.Kafka.Name }}").Str("topic", "{{ $topic.ID }}").Msg("kafka disabled: message not published")
		return nil
	}

	start := time.Now()
	topicName := p.topicNames["{{ $topic.ID }}"]

{{- if $topic.GoType }}
	data, err := json.Marshal(msg)
	if err != nil {
		p.metrics.RecordError("{{ $topic.ID }}", "marshal")
		return fmt.Errorf("marshal message: %w", err)
	}
{{- else }}
	data := msg
{{- end }}

	err {{ if not $topic.GoType }}:{{ end }}= p.writer.WriteMessages(ctx, kafka.Message{
		Topic: topicName,
		Key:   key,
		Value: data,
	})

	p.metrics.RecordLatency("{{ $topic.ID }}", time.Since(start))
	if err != nil {
		p.metrics.RecordError("{{ $topic.ID }}", "publish")
		return fmt.Errorf("publish to %s: %w", topicName, err)
	}

	p.metrics.RecordSuccess("{{ $topic.ID }}")
	return nil
}

// Publish{{ $topic.ID | Capitalize | ReplaceDash }}Async sends a message asynchronously to topic "{{ $topic.ID }}" (fire and forget)
{{- if $topic.GoType }}
func (p *Producer) Publish{{ $topic.ID | Capitalize | ReplaceDash }}Async(key []byte, msg {{ $topic.GoType }}) {
{{- else }}
func (p *Producer) Publish{{ $topic.ID | Capitalize | ReplaceDash }}Async(key []byte, msg []byte) {
{{- end }}
	if p.disabled {
		return
	}

	topicName := p.topicNames["{{ $topic.ID }}"]

{{- if $topic.GoType }}
	data, err := json.Marshal(msg)
	if err != nil {
		p.metrics.RecordError("{{ $topic.ID }}", "marshal")
		return
	}
{{- else }}
	data := msg
{{- end }}

	p.PublishAsync(topicName, key, data)
}
{{ end }}
